<%
  function computeOldLineNumber(change) {
    if (change.isInsert) {
      return -1;
    }

    return change.isNormal ? change.oldLineNumber : change.lineNumber;
  }

  function computeNewLineNumber(change) {
    if (change.isDelete) {
      return -1;
    }

    return change.isNormal ? change.newLineNumber : change.lineNumber;
  }

  function groupElements(changes) {
    var elements = [];

    for (var i = 0; i < changes.length; i++) {
      var current = changes[i];

      if (current.isNormal) {
        elements.push(['change', current, current]);
      } else if (current.isDelete) {
        var next = changes[i + 1];
        if (next && next.isInsert) {
          i = i + 1;
          elements.push(['change', current, next]);
        } else {
          elements.push(['change', current, null])
        }
      } else {
        elements.push(['change', null, current]);
      }
    }

    return elements;
  }

  function lineTypeClassName(oldChange, newChange) {
    if (oldChange && !newChange) {
      return 'diff-line-old-only';
    }

    if (!oldChange && newChange) {
      return 'diff-line-new-only';
    }

    if (oldChange === newChange) {
      return 'diff-line-normal';
    }

    return 'diff-line-compare';
  }
%>

<tbody class="diff-hunk">
  <% groupElements(hunk.changes).forEach(function (element) { %>
    <tr class="diff-line <%= lineTypeClassName(element.oldChange, element.newChange) %>">
      <% if (element.oldChange) { %>
        <td 
          key="gutter"
          class="diff-gutter diff-gutter-<%= element.type %>"
          data-line-number="<%= computeOldLineNumber(element) === -1 ? undefined : computeOldLineNumber(element)%>"
        />
        <td 
          key="code" 
          class="diff-code diff-code-<%= change.type %>"
        >
          <%= element.content %>
        </td>
      <% } else { %>
        <td key="gutter" class="diff-gutter diff-gutter-omit"></td>
        <td key="code" class="diff-code diff-code-omit"></td>
      <% } %>

      <% if (element.newChange) { %>
        <td 
          key="gutter"
          class="diff-gutter diff-gutter-<%= element.type %>"
          data-line-number="<%= computeNewLineNumber(element) === -1 ? undefined : computeNewLineNumber(element)%>"
        />
        <td 
          key="code" 
          class="diff-code diff-code-<%= change.type %>"
        >
          <%= element.content %>
        </td>
      <% } else { %>
        <td key="gutter" class="diff-gutter diff-gutter-omit"></td>
        <td key="code" class="diff-code diff-code-omit"></td>
      <% } %>
    </tr>
  <% }) %>
</tbody>